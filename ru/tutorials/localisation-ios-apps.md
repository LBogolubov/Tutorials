В этом туториале расскажем все о локализации iOS приложений, как она работает и какие инструменты могут помочь в работе с ней. 

![Preview](https://cdn.sparrowcode.io/articles/localisation-ios-apps/preview-ru.jpg)

## Введение

Локализация iOS приложения подразумевает собой не только перевод на рызные языки через ключи, ведь многие требуют индивидуального подхода. Например иногда нужно локализовать изображение или изменить размер шрифта для определенного языка. Этот туториал ориентирован как на начинающих разработчиков, которые впервые столкнулись с локализацией, так и для опытных, которым мы покажем тру-вей по работе с ней. Начнем.

### Как устроена локализация

Для того, что бы локализовать основной текст в приложении нам понадобится `NSLocalizedString` - макрос, который возвращает локализованную строку и имеет 2 аргумента: ключ и комментарий. 

```swift
	let localisedString = NSLocalizedString(
		"label text", // Уникальный ключ, по которому мы поймем какую строку локализуем
		comment: "Макисмум 2 слова" // Комментарий, в котором можно уточнить информацию для переводчика (можно оставить пустым)
	)
```

> Каждый ключ должен быть уникальным для того что бы избежать ошибок в локализации. Ничего страшного не произойдет и программа скомпилируется, но может вернуться неправильное значение.

Такой макрос попадёт в файл `Localizable.strings`, который автоматически создаст XCode после экспорта и импорта локализаций в формате "ключ" = "значение":

```swift
/* Макисмум 2 слова */
"label text" = "Localised text";
```

Теперь при запросе ключа "label text" в коде нам вернется локализованное значение, в нашем случае "Localised text". Если использовать в коде не локализованный ключ - на месте текста отобразится он сам.

### InfoPlist

`InfoPlist` - ресурс, содержащий ключ-пары для идентификации и конфигурации бандла.

Здесь нас интересует то, что все эти значения тоже можно и нужно локализовать. Например название приложения автоматически появится в `xloc` файле после экспорта и его можно будет перевести. После импорта появится в файле `InfoPlist.strings`, который так же автоматически создаст XCode. 

Точно так же появятся локализационные ключи разрешений, которые вы добавите в свое приложение. Например можно перевести для чего вам нужен доступ к камере на разные языки.

### Передача параметров в локализационный ключ

В `NSLocalizedString` можно передавать параметры при помощи спецификатора формата `String`, например:

```swift
	let parametrString = "Empty" // Текст, который хотим передать 

    let localisedString = String.init(
        format: NSLocalizedString(
            "label text %@", // На месте %@ появится текст, который мы передадим ниже
            comment: ""
        ), parametrString // Указываем переменную, которую передаем
    )
```

Теперь при выводе `localisedString` мы получим "label text Empty". При локализации можно переносить спецификатор и при выводе на его месте появится информация из переданной нам переменной.

**Можно передавать несколько параметров**

```swift
	let parametrString = "Make Apple"
	let secondParametrString = "great again"
	let parametrInt = 941

	let localisedString = String.init(
        format: NSLocalizedString(
            "label text %@ %@ %d",
            comment: ""
        ), parametrString, secondParametrString, parametrInt // Текст на месте спецификатора появится в том порядке, в каком вы его передадите
    )
```

Если в локализационной строке встетится два одинаковых спецификатора XCode автоматически пронумерует их в экспорте. В локализационном файле это будет выглядеть примерно так:

```swift
"label text %@ %@ %d" = "Lets %1$@ a true %2$@ at %3$d o’clock";
```

Теперь при выводе переменной `localisedString` мы получим следующий текст: Lets Make Apple a true great again at 941 o'clock

Именно для этого мы и передаем переменные в том порядке, в каком хотим видеть их в тексте. Например если сконфигурируем `localisedString` так: 

```swift
    let parametrString = "Make Apple"
    let secondParametrString = "great again"
    let parametrInt = 941

	let localisedString = String.init(
        format: NSLocalizedString(
            "label text %@ %@ %d",
            comment: ""
        ), secondParametrString, parametrString, parametrInt // Меняем parametrString и secondParametrString местами
    )
```

При выводе получим: Lets great again a true Make Apple at 941 o'clock

**Есть разные спецификаторы**

%@ - для значений String;
%d - для значений Int;
%f - для значений Float;
%ld - для значений Long;

Познакомиться с остальными спецификаторами можно на сайте Apple Developer [по ссылке](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Strings/Articles/formatSpecifiers.html).

## Export и import локализации

Переходим в Products и видим две кнопки Export и Import localisations.

![Фотография с расположением кнопок](https://cdn.sparrowcode.io/articles/localisation-ios-apps/products_export_and_import_instruction.png)

Export позволяет вывести локализационные ключи для их дальнейшей локализации.

![Фотография с выведенными при экспорте файлами](https://cdn.sparrowcode.io/articles/localisation-ios-apps/exported-files-preview.jpg)

Xcode создает Localization Catalog (папку с расширением файла .xcloc), содержащую локализуемые ресурсы для каждого языка и региона. Для того что бы локализовать приложение на нужный язык достаточно открыть каталог.

![Фотография встроенного переводчика в Xcode](https://cdn.sparrowcode.io/articles/localisation-ios-apps/xloc-ru-localisation-preview.png)

Это встроенный в XCode переводчик. На сайдбаре есть 2 файла - InfoPlist и Localizable, здесь они переводятся отдельно.

В первой колонке виден ключ, во второй мы сами заполняем перевод, а в третьей будет комментарий (если оставляли при конфигурации `NSLocalizedString`). Точно так же работает перевод InfoPlist файла. 

После того, как выполнили перевод - сохраняем файл и возвращаемся в проект. Снова переходим в Product, но уже выбираем "Import Localizations". 

![Фотография с импортом xloc каталогов](https://cdn.sparrowcode.io/articles/localisation-ios-apps/import-files-preview.jpg)

Здесь по-отдельности выбираем каждый каталог и загружаем в проект. Вуаля! В файле `Localizable.strings` нужного языка появятся все переведённые ключи:

```swift
/* No comment provided by engineer. */
"key a" = "Буква А";

/* No comment provided by engineer. */
"key b" = "Буква Б";

/* No comment provided by engineer. */
"key c" = "Буква С";

/* No comment provided by engineer. */
"key d" = "Буква Д";

/* No comment provided by engineer. */
"key e" = "Буква Е";
``` 

Перевод можно изменять прямо в файле, при следующем экспорте XCode считает это и изменения отобразятся в xloc.

На этом этапе многие закроют ноутбук и откроют шампанское, но не стоит торопиться. Встроенный переводчик подойдет если надо перевести небольшой объем текста, для более крупных задач подойдет [Poedit](https://poedit.net).

Возвращаемся на 2 минуты назад. Мы снова в папке с xloc каталогами. Вместо того, что бы открыть его левой кнопкой мыши нажимаем правую и переходим в содержимое пакета.

![Фотография содержимого каталога xloc](https://cdn.sparrowcode.io/articles/localisation-ios-apps/xloc-inside.jpg)

Глаза разбегаются, но не стоит паниковать - здесь нас интересует папка "Localized Contents". Внутри будет `xliff` файл, открываем его через Poedit.

![Фотография Poedit](https://cdn.sparrowcode.io/articles/localisation-ios-apps/poedit-preview.png)

Здесь есть все локализационные ключи списком. Выбираете нужный, внизу появляется исходный ключ и поле для ввода перевода. Если перевели приложение на основной английский язык - вместо локализационных ключей будет отображаться перевод на него. Справа есть варианты перевода, а так же локализационный ключ и комментарий. С премиумом можно предварительно перевести все ключи. Poedit подсветит ошибке в локализации. 

После перевода сохраняете файл и так же импортируете `xloc` в проект.

## Автогенерация

Что бы добавить новый язык в проект нужно перейти в настройки проекта -> Info.

![Фотография добавления нового языка в настройках проекта](https://cdn.sparrowcode.io/articles/localisation-ios-apps/add-new-language.png)

Здесь ищем секцию "Localizations" и плюс, через который добавляем столько языков, сколько нам нужно.

XCode автоматически сгенерирует `xloc` файл для каждого языка при экспорте, и strings-файлы при импорте. Есть одно НО - при смене ключа в переменной старый ключ останется в strings-файле даже после экспорта, а не локализованный - при импорте.

Эти и многие другие ошибки появляются в результате автогенерации из-за чего при создании большого проекта файлы с локализациями превращаются в кашу и с ними становится трудно работать. В XCode есть встроенные инструменты, которые могут помочь справиться с этим, но они применяются слишком редко. По статистике при такой работе кресло среднестатистического разработчика полностью сгорает за 15 минут, но у нас есть выход - библиотека [BartyCrouch](https://github.com/Flinesoft/BartyCrouch).

Она автоматически ищет все локализации в проекте и икнрементально обновляет strings-файлы при появлении новых или удалении старых `NSLocalizedString` или `views` в Storyboard и XIB. Сортирует ключи по алфавиту, что бы избежать конфликтов слияния. Дает исключить некоторые view в Storyboard и XIB что бы они не локализовались вовсе. 

Выхода нет - добавляем в проект:


## Плюрализация

## Локализация пакетов

## Локализация значений для валюты, даты и цифр

## Локализация шрифтов и изображений

## Тру-вей в работе с локализациями
